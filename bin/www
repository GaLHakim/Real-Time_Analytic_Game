#!/usr/bin/env node

/**
 * Module dependencies.
 */

const app = require('../app');
const debug = require('debug')('knex-nodejs:server');
const http = require('http');
const db = require('../models');

/**
 * Get port from environment and store in Express.
 */

const port = normalizePort(process.env.PORT || '3000');
app.set('port', port);

/**
 * Create HTTP server.
 */

const server = http.createServer(app);

const Activity = require('../models').Activity;
const Project = require('../models').Project;

//#region Socket IO
const formatMessage = require('../public/js/cloud/activity/formatMessage');
const { userJoin, getCurrentUser } = require('../public/js/cloud/activity/users');
const socketIo = require('socket.io');
io = socketIo(server);

// var clients = [];
io.on('connection', (socket) => {

  socket.on('Join Room', room =>{
    const user = userJoin(socket.id, room);
    socket.join(user.room);
    console.log({
      success: 'room Join Room',
      message: user.room
    })
  })

  socket.on('User Connect', (dataConnect) => {
    console.log('User Connect ' + socket.id + dataConnect);
    Project
    .findOne({
      where:{
        id: dataConnect.ProjectId
      },
      attributes:[
        'DeveloperId'
      ]
    })
    .then(data => {
      metaDevId = data.DeveloperId;
      const user = userJoin(socket.id, metaDevId);
      socket.join(user.room);
      console.log({
        success: 'room User Connect',
        message: user.room
        })
    })
    .catch(err => {
      console.log({
        error: true,
        message: 'error socket join : '+err
      })
    })
    // for(var i = 0; i < clients.length; i++){
    //   // socket.emit('User Connected', {item:clients[i]});
    //   console.log('User Connected is ' + clients[i] , socket.id);
    // }
  });
  
  socket.on('Action', (dataAction) => {
    console.log(dataAction);
    Project
    .findOne({
      where:{
        id: dataAction.ProjectId
      },
      attributes:[
        'project_name'
      ]
    })
    .then(data => {
      metaProjectName = data.project_name;
      const user = getCurrentUser(socket.id)
      io.to(user.room).emit('LogAction', formatMessage(metaProjectName, dataAction.object_name));
      console.log({
        success: 'room Action',
        message: user.room
      })
    })
    .catch(err => {
      console.log({
        error: true,
        message: 'error then data : '+err
      })
    })
    activity(dataAction);
    // actProject(dataAction);
  });

  socket.on('disconnect', () => {
    console.log('User disconnect is', socket.id);
    // socket.emit('User Disconnected', socket.id);
  });
});
//#endregion

//#region Pusher
const Pusher = require('pusher');
const keys = require('../config/pusherKeys');

function activity(dataAction){
    var pusher = new Pusher({
      appId: keys.pusherAppId,
      key: keys.pusherKey,
      secret: keys.pusherSecret,
      cluster: keys.pusherCluster,
      encrypted: keys.pusherEncrypted
    });

    const dataAct = {
      object_name: dataAction.object_name,
      ProjectId: dataAction.ProjectId,
      EventTypeId: dataAction.EventTypeId
    }

    Activity
    .create(dataAct)
    .then(() => {
      if(dataAct.EventTypeId == '1' || dataAct.EventTypeId ==  '2'){
        console.log('data id 1 & 2');
        pusher.trigger('active', 'active-e', {
          points: 1,
          object_name:dataAct.object_name
        });
      }else if(dataAct.EventTypeId == '3' || dataAct.EventTypeId ==  '3'){
        console.log('data id 3 & 4');
        pusher.trigger('button', 'button-e', {
          points: 1,
          object_name:dataAct.object_name
        });
      }
      console.log({
        status: 'succes',
        message: 'dataAct Create',
        data: dataAct
      });
    })
    .catch(err => {
      console.log({
        error: true,
        message: 'error create : ' + err
      })
    })
}
//#endregion

/**
 * Listen on provided port, on all network interfaces.
 */
db.sequelize.sync().then(() => {
  server.listen(port);
  server.on('error', onError);
  server.on('listening', onListening);
});

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
  var port = parseInt(val, 10);

  if (isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }

  var bind = typeof port === 'string'
    ? 'Pipe ' + port
    : 'Port ' + port;

  // handle specific listen errors with friendly messages
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
  var addr = server.address();
  var bind = typeof addr === 'string'
    ? 'pipe ' + addr
    : 'port ' + addr.port;
  debug('Listening on ' + bind);
}